<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Animasyon FabrikasÄ±</title>
  <style>
    :root{ --bg:#0b0b0b; --panel:#111; --accent:#e50914; --muted:#777; color-scheme: dark; }
    html,body{ height:100%; margin:0; font-family: Arial, Helvetica, sans-serif; background:var(--bg); color:#fff; }
    header{ padding:16px; font-size:20px; font-weight:700; background:var(--panel); border-bottom:1px solid #111; }
    .container{ padding:16px; max-width:980px; margin:16px auto; }
    label{ display:block; margin-top:12px; font-weight:600; }
    select, textarea, input[type="text"], .controls button, input[type="range"] {
      width:100%; margin:8px 0; padding:10px; border-radius:8px; border:none; background:#121212; color:#fff;
    }
    .controls{ display:flex; gap:10px; margin-top:8px; }
    .controls button{ flex:1; cursor:pointer; padding:10px 12px; border-radius:8px; }
    button.save{ background:var(--accent); color:#fff; font-weight:700; }
    button.play{ background:#0a7; color:#000; font-weight:700; }
    button.ghost{ background:#333; color:#fff; }
    .scene{ margin-top:16px; padding:14px; background:var(--panel); border-radius:10px; animation:fadeIn 0.35s ease; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;} }
    .player{ margin-top:18px; padding:14px; background:#000; border-radius:10px; min-height:100px; }
    .small{ opacity:0.75; font-size:13px; color:var(--muted); }
    .saved-list{ margin-top:12px; display:grid; gap:10px; }
    .saved-item{ padding:10px; background:#0f0f0f; border-radius:8px; display:flex; gap:10px; align-items:flex-start; }
    .saved-item .meta{ flex:1; }
    .saved-item .meta p{ margin:0 0 6px 0; line-height:1.4; }
    .saved-item .actions{ display:flex; gap:8px; flex-direction:column; }
    .pop { transform:scale(1.02); box-shadow:0 8px 30px rgba(0,0,0,0.6); transition:transform 0.25s ease; }
    footer{ margin-top:18px; color:var(--muted); font-size:13px; text-align:center; }
    .inline-row { display:flex; gap:8px; align-items:center; }
    .inline-row > * { flex:1; }
    .label-muted { font-size:13px; color:var(--muted); margin-top:6px; }
    @media(min-width:640px){
      .controls button{ width:auto; flex:unset; padding:10px 16px; }
      .saved-item .actions{ flex-direction:row; }
      .inline-row > * { flex:unset; }
    }
  </style>
</head>
<body>
  <header>ğŸ¬ Animasyon FabrikasÄ± â€” Basit Demo</header>
  <main class="container">
    <label>ğŸ­ TÃ¼rler (Ã§oklu seÃ§)</label>
    <select multiple size="4" aria-label="TÃ¼rler">
      <option>Aksiyon</option><option>Korku</option><option>Dram</option><option>Komedi</option>
      <option>Fantastik</option><option>Macera</option><option>BL</option><option>GL</option>
    </select>

    <label>ğŸ¨ Ã‡izim TarzÄ±</label>
    <select aria-label="Ã‡izim TarzÄ±">
      <option>Anime</option><option>Webtoon</option><option>Cartoon</option>
      <option>Dark</option><option>Horror</option><option>Realistic</option>
    </select>

    <label>âœï¸ Senaryo</label>
    <textarea id="story" rows="6" placeholder="Mehmet karanlÄ±k koridorda yÃ¼rÃ¼r. KapÄ± gÄ±cÄ±rdar..."></textarea>

    <div class="controls" role="group" aria-label="Senaryo kontrolleri">
      <button class="save" id="saveBtn">ğŸ’¾ Senaryoyu Kaydet</button>
      <button class="play" id="playBtn">â–¶ï¸ Animasyonu Oynat</button>
      <button class="ghost" id="clearBtn">ğŸ—‘ï¸ TÃ¼mÃ¼nÃ¼ Temizle</button>
    </div>

    <!-- Yeni: KonuÅŸma / Ses AyarlarÄ± (Ã¼cretsiz, Web Speech API kullanÄ±r) -->
    <div class="scene" aria-hidden="false" style="margin-top:12px;">
      <label>ğŸ”Š Ses AyarlarÄ± (Ãœcretsiz)</label>
      <div class="inline-row">
        <select id="voiceSelect" aria-label="Ses seÃ§imi">
          <option>YÃ¼kleniyor...</option>
        </select>
      </div>
      <div class="inline-row" style="margin-top:8px;">
        <div style="flex:1">
          <label class="label-muted">HÄ±z (rate): <span id="rateVal">0.95</span></label>
          <input id="rate" type="range" min="0.6" max="1.6" step="0.05" value="0.95" />
        </div>
        <div style="flex:1">
          <label class="label-muted">Perde (pitch): <span id="pitchVal">1</span></label>
          <input id="pitch" type="range" min="0.5" max="2" step="0.1" value="1" />
        </div>
      </div>
      <div style="margin-top:8px;">
        <label class="label-muted"><input id="ttsToggle" type="checkbox" checked /> KonuÅŸmayÄ± kullan (Web Speech API) â€” deÄŸilse otomatik sÃ¼re tahmini kullanÄ±lÄ±r</label>
      </div>
      <div class="label-muted" style="margin-top:8px;">Not: Bu Ã¶zellik tamamen Ã¼cretsiztir; tarayÄ±cÄ±nÄ±zÄ±n Web Speech API'sini kullanÄ±r. BazÄ± tarayÄ±cÄ±larda sesler farklÄ± isimlerde olabilir.</div>
    </div>

    <div id="saved" class="saved-list" aria-live="polite"></div>

    <div id="player" class="player" aria-live="polite"></div>

    <footer class="small">Basit bir statik demo â€” Web Speech API konuÅŸma ve sahne gÃ¶stergesi iÃ§erir.</footer>
  </main>

  <script>
    const story = document.getElementById('story');
    const saved = document.getElementById('saved');
    const player = document.getElementById('player');
    const saveBtn = document.getElementById('saveBtn');
    const playBtn = document.getElementById('playBtn');
    const clearBtn = document.getElementById('clearBtn');

    const voiceSelect = document.getElementById('voiceSelect');
    const rateInput = document.getElementById('rate');
    const pitchInput = document.getElementById('pitch');
    const rateVal = document.getElementById('rateVal');
    const pitchVal = document.getElementById('pitchVal');
    const ttsToggle = document.getElementById('ttsToggle');

    let stories = JSON.parse(localStorage.getItem('stories') || '[]');

    function escapeHTML(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function renderSaved(){
      saved.innerHTML = '';
      if(!stories.length){
        saved.innerHTML = '<p class="small">ğŸ“š KayÄ±tlÄ± senaryo yok.</p>';
        return;
      }
      stories.forEach((s,i)=>{
        const item = document.createElement('div');
        item.className = 'saved-item';
        const meta = document.createElement('div');
        meta.className = 'meta';
        const title = document.createElement('div');
        title.className = 'small';
        title.textContent = `Senaryo ${i+1}`;
        const snippet = document.createElement('p');
        snippet.innerHTML = escapeHTML(s).slice(0,300) + (s.length>300 ? 'â€¦' : '');
        meta.appendChild(title);
        meta.appendChild(snippet);

        const actions = document.createElement('div');
        actions.className = 'actions';
        const playBtn = document.createElement('button');
        playBtn.className = 'play';
        playBtn.textContent = 'Oynat';
        playBtn.onclick = ()=> play(s);

        const delBtn = document.createElement('button');
        delBtn.className = 'ghost';
        delBtn.textContent = 'Sil';
        delBtn.onclick = ()=>{
          if(confirm('Bu senaryoyu silmek istediÄŸinize emin misiniz?')){
            del(i);
          }
        };

        actions.appendChild(playBtn);
        actions.appendChild(delBtn);

        item.appendChild(meta);
        item.appendChild(actions);
        saved.appendChild(item);
      });
    }

    function saveStory(){
      const text = story.value.trim();
      if(!text) return alert('Senaryo boÅŸ');
      stories.push(text);
      localStorage.setItem('stories', JSON.stringify(stories));
      story.value = '';
      renderSaved();
    }

    function del(index){
      stories.splice(index,1);
      localStorage.setItem('stories', JSON.stringify(stories));
      renderSaved();
    }

    // Sahnele bÃ¶lme
    function splitScenes(text, maxLen = 120){
      if(!text) return [];
      const sentences = text.match(/[^.!?]+[.!?]*/g) || [text];
      const out = [];
      let current = '';
      for(const s of sentences){
        const part = s.trim();
        if(!part) continue;
        if((current + ' ' + part).trim().length <= maxLen){
          current = (current + ' ' + part).trim();
        } else {
          if(current) out.push(current);
          if(part.length > maxLen){
            for(let i=0;i<part.length;i+=maxLen){
              out.push(part.substring(i, i+maxLen).trim());
            }
            current = '';
          } else {
            current = part;
          }
        }
      }
      if(current) out.push(current);
      return out;
    }

    // SpeechSynthesis ses listesi / seÃ§imi (Ã¼cretsiz)
    let voices = [];
    function loadVoices(){
      if(!('speechSynthesis' in window)){
        voiceSelect.innerHTML = '<option>TarayÄ±cÄ±da Web Speech API yok</option>';
        return;
      }
      voices = window.speechSynthesis.getVoices() || [];
      voiceSelect.innerHTML = '';
      if(!voices.length){
        voiceSelect.innerHTML = '<option>Sesler yok (bekleniyor)</option>';
        return;
      }
      voices.forEach((v, idx)=>{
        const o = document.createElement('option');
        o.value = idx;
        o.textContent = `${v.name} â€” ${v.lang}` + (v.default ? ' (default)' : '');
        voiceSelect.appendChild(o);
      });
      // varsayÄ±lan olarak TÃ¼rkÃ§e bir ses aramaya Ã§alÄ±ÅŸ
      const trIdx = voices.findIndex(v => /tr(-|$)/i.test(v.lang));
      voiceSelect.value = (trIdx >= 0 ? trIdx : voices.findIndex(v => v.default) || 0);
    }
    if('speechSynthesis' in window){
      window.speechSynthesis.onvoiceschanged = loadVoices;
      loadVoices();
    } else {
      loadVoices();
    }

    // KonuÅŸma: onend eventi ile otomatik sahne geÃ§iÅŸi
    function speakWithEvents(text){
      return new Promise((resolve)=>{
        if(!ttsToggle.checked || !('speechSynthesis' in window)){
          // fallback: tahmini sÃ¼re (kelime sayÄ±sÄ±na gÃ¶re)
          const words = (text.trim().split(/\s+/).filter(Boolean)).length || 1;
          // base WPM ~ 130, rate etkiler
          const baseWPM = 130;
          const rate = parseFloat(rateInput.value) || 1;
          const estimatedMs = Math.max(600, Math.round((words / (baseWPM * rate)) * 60 * 1000));
          setTimeout(resolve, estimatedMs);
          return;
        }
        try{
          // iptal etmeden Ã¶nce mevcutleri durdurma (ancak entegrasyon iÃ§in iptal etmiyoruz burada)
          // window.speechSynthesis.cancel();
          const utt = new SpeechSynthesisUtterance(text);
          utt.rate = parseFloat(rateInput.value) || 0.95;
          utt.pitch = parseFloat(pitchInput.value) || 1;
          utt.lang = 'tr-TR'; // tercihen
          // seÃ§ili voice varsa ata
          const idx = parseInt(voiceSelect.value);
          if(!Number.isNaN(idx) && voices[idx]) utt.voice = voices[idx];
          let fired = false;
          utt.onend = ()=>{
            if(fired) return;
            fired = true;
            resolve();
          };
          utt.onerror = (e)=>{
            if(fired) return;
            fired = true;
            // hata olursa kÃ¼Ã§Ã¼k bir bekleme ile devam et
            console.warn('TTS hata', e);
            setTimeout(resolve, 350);
          };
          window.speechSynthesis.speak(utt);
          // gÃ¼venlik: 30s aÅŸÄ±rÄ± uzunluÄŸa karÅŸÄ± zaman aÅŸÄ±mÄ±
          setTimeout(()=>{ if(!fired){ fired = true; resolve(); } }, 30000);
        }catch(e){
          console.warn('speakWithEvents hata', e);
          setTimeout(resolve, 600);
        }
      });
    }

    // Sahne oynatma: her sahneyi speakWithEvents ile ilerlet
    async function play(text){
      const scenes = splitScenes(text, 120);
      if(!scenes.length){
        alert('OynatÄ±lacak sahne yok.');
        return;
      }
      // EÄŸer zaten oynatÄ±lÄ±yorsa Ã¶ncekileri iptal et
      if('speechSynthesis' in window) window.speechSynthesis.cancel();
      player.innerHTML = '';
      for(let i=0;i<scenes.length;i++){
        const s = scenes[i];
        player.innerHTML = `
          <div class="scene pop">
            <h3>Sahne ${i+1}</h3>
            <p>${escapeHTML(s)}</p>
            <p class="small">Karakter: Mehmet</p>
          </div>
        `;
        // kÃ¼Ã§Ã¼k gÃ¶rsel efekt
        setTimeout(()=> {
          const el = player.querySelector('.scene');
          if(el) el.classList.remove('pop');
        }, 350);
        // konuÅŸma veya tahmini sÃ¼reye gÃ¶re bekle
        await speakWithEvents(s);
      }
      // oynatma bittiÄŸinde bilgi ver
      player.innerHTML += `<div class="small" style="margin-top:10px; opacity:0.9;">Oynatma tamamlandÄ±.</div>`;
    }

    // ArayÃ¼z baÄŸlama
    saveBtn.addEventListener('click', saveStory);
    playBtn.addEventListener('click', ()=> play(story.value));
    clearBtn.addEventListener('click', ()=>{
      if(confirm('TÃ¼m kayÄ±tlÄ± senaryolar yerelden silinsin mi?')){
        stories = [];
        localStorage.removeItem('stories');
        renderSaved();
        player.innerHTML = '';
        if('speechSynthesis' in window) window.speechSynthesis.cancel();
      }
    });

    rateInput.addEventListener('input', ()=> { rateVal.textContent = rateInput.value; });
    pitchInput.addEventListener('input', ()=> { pitchVal.textContent = pitchInput.value; });

    // BaÅŸlangÄ±Ã§ render
    renderSaved();
  </script>
</body>
</html>